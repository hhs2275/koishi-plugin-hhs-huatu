# 会员系统

会员系统为重度用户提供更好的使用体验，支持差异化的每日限额和冷却时间。

::: warning 可选功能
会员系统默认关闭，需要在配置中手动启用。
:::

## 功能特性

### 基础功能

- ✅ **会员权限管理**：授予、取消、查询会员资格
- ✅ **自动时长叠加**：重复授予自动延长会员时间
- ✅ **差异化服务**：会员享受更高限额和更短冷却
- ✅ **会员列表**：支持分页查看所有会员

### 高级功能

- ✅ **自动清理**：定时清理过期会员和不活跃用户数据
- ✅ **到期提醒**：提前提醒即将到期的会员
- ✅ **调试工具**：管理员可手动触发清理和提醒任务

## 配置说明

### 启用会员系统

在插件配置的「会员系统设置」中：

```yaml
membershipEnabled: true           # 启用会员系统
membershipAuthLv: 3               # 管理会员所需权限等级
```

### 基础配置

| 配置项 | 说明 | 推荐值 |
|--------|------|--------|
| 非会员每日限额 | 非会员每天可用次数 | 5-10 |
| 会员每日限额 | 会员每天可用次数（0=无限） | 0 或 50+ |
| 非会员冷却时间 | 每次绘图后的冷却（秒） | 60 |
| 会员冷却时间 | 会员冷却时间（0=无冷却） | 0 或 10 |

### 自动清理配置

```yaml
memberCleanupEnabled: true        # 启用自动清理
memberCleanupTime: "00:00"        # 每天凌晨0点清理
cleanupNonMembers: true           # 同时清理非会员数据
nonMemberInactiveDays: 7          # 7天未使用的非会员会被清理
```

### 到期提醒配置

```yaml
memberExpiryReminderEnabled: true # 启用到期提醒
memberReminderTime: "12:00"       # 每天中午12点检查
memberReminderHours: 24           # 提前24小时提醒
memberReminderGroups:             # 接收提醒的群组ID
  - "123456789"
  - "987654321"
```

### 调试功能配置

```yaml
memberDebugCommandEnabled: true   # 启用调试指令
memberDebugCommandAuthLv: 4       # 使用调试指令所需权限
```

## 使用指令

### 查询状态

```bash
# 查询自己的会员状态
会员

# 返回示例（会员）
# 您当前是会员用户，可无限次使用
# 会员到期时间：2024-12-31 23:59:59（剩余30天）

# 返回示例（非会员）
# 您的每日绘图次数：5 次
# 今日已使用：2 次
# 剩余次数：3 次
```

### 查询其他用户

```bash
# 需要管理员权限
会员 -u 123456789

# 返回示例
# 用户 123456789 是会员用户
# 每日限额：0 次，剩余：0 次
# 会员到期时间：2024-12-31 23:59:59（剩余30天）
```

### 授予会员

```bash
# 授予30天会员（需管理员权限）
会员 -u 123456789 -d 30

# 再次授予会自动叠加时间
会员 -u 123456789 -d 7    # 会员时长变为 37 天
```

### 取消会员

```bash
# 取消指定用户的会员资格（需管理员权限）
会员 -u 123456789 -c
```

### 查看会员列表

```bash
# 查看所有会员（第一页）
会员 -l

# 查看第二页
会员 -l -p 2

# 每页显示20条
会员 -l -s 20

# 第3页，每页30条
会员 -l -p 3 -s 30
```

返回示例：
```
【会员列表】第 1 页 / 共 3 页

1. 用户ID: 123456789
   到期时间: 2024-12-31 23:59:59
   剩余天数: 30 天

2. 用户ID: 987654321
   到期时间: 2024-12-25 12:00:00
   剩余天数: 24 天

...

共 25 位会员
```

## 调试指令

::: warning 需要配置启用
调试指令需要在配置中启用 `memberDebugCommandEnabled`。
:::

### 查看系统状态

```bash
会员调试 -s
```

返回示例：
```
【会员系统状态】

✅ 自动清理：已启用
   清理时间：每天 00:00
   清理范围：过期会员 + 非会员 (7天未使用)
   下次执行：2024-01-02 00:00:00

✅ 到期提醒：已启用
   检查时间：每天 12:00
   提醒阈值：提前 24 小时
   提醒群组：2 个
   下次执行：2024-01-01 12:00:00

【用户统计】
总用户数：150
有效会员：25
过期会员：5
非会员：120
```

### 手动执行清理

```bash
会员调试 -c
```

返回示例：
```
✅ 清理完成！

共清理 12 条记录

【过期会员】(5 个)
1. 123456789
2. 234567890
...

【非会员】(7 个，不活跃 7 天)
1. 345678901
2. 456789012
...
```

### 手动执行提醒

```bash
会员调试 -r
```

返回示例：
```
✅ 提醒完成！

发现 3 位即将到期的会员
已向 2/2 个群组发送提醒
```

## 工作原理

### 差异化服务

| 特性 | 非会员 | 会员 |
|------|--------|------|
| 每日限额 | 配置的限额（如5次） | 无限或更高限额 |
| 冷却时间 | 配置的冷却（如60秒） | 无冷却或更短 |
| 队列优先级 | 普通 | 普通（可扩展） |

### 自动清理

每天在配置的时间（如凌晨 0:00）自动执行：

1. **清理过期会员**：会员到期时间 < 当前时间
2. **清理不活跃非会员**：
   - 可配置不活跃天数阈值
   - 设为 0 则清理所有非会员
   - 基于最后使用时间判断

### 到期提醒

每天在配置的时间（如中午 12:00）自动执行：

1. **检查即将到期的会员**：剩余时间 < 提醒阈值（如24小时）
2. **向指定群组发送提醒**：包含用户ID、剩余时间、到期时间
3. **日志记录**：记录提醒发送情况

## 使用场景

### 小型社区

```yaml
membershipEnabled: true
nonMemberDailyLimit: 5        # 非会员每天5次
memberDailyLimit: 0           # 会员无限制
nonMemberCooldown: 60         # 非会员60秒冷却
memberCooldown: 0             # 会员无冷却
```

### 大型社区

```yaml
membershipEnabled: true
nonMemberDailyLimit: 3        # 非会员每天3次
memberDailyLimit: 50          # 会员每天50次
nonMemberCooldown: 120        # 非会员120秒冷却
memberCooldown: 10            # 会员10秒冷却

# 启用自动清理
memberCleanupEnabled: true
cleanupNonMembers: true
nonMemberInactiveDays: 7      # 清理7天未使用的非会员

# 启用到期提醒
memberExpiryReminderEnabled: true
memberReminderHours: 48       # 提前48小时提醒
```

### 付费服务

```yaml
membershipEnabled: true
nonMemberDailyLimit: 0        # 非会员不可用
memberDailyLimit: 0           # 仅会员可用，无限制
```

## 最佳实践

### 1. 合理设置限额

- 根据服务器负载调整
- 考虑 NovelAI API 的限制
- 平衡用户体验和成本

### 2. 定期清理数据

- 启用自动清理功能
- 避免数据文件过大
- 保持系统性能

### 3. 提前提醒到期

- 设置合理的提醒时间
- 给用户续费的缓冲时间
- 提高用户满意度

### 4. 使用调试工具

- 定期查看系统状态
- 手动执行清理测试
- 监控会员数量变化

## 常见问题

### 会员授予后立即生效吗？

是的，立即生效。用户下次使用时就会享受会员待遇。

### 会员时长可以叠加吗？

可以！重复授予会员会自动延长到期时间。

### 如何批量授予会员？

目前需要逐个授予，未来可能添加批量导入功能。

### 清理功能会影响当前会员吗？

不会。清理只会删除：
- 已过期的会员数据
- 符合不活跃条件的非会员数据

有效会员数据会被保留。

### 提醒消息发送到哪里？

发送到配置的 `memberReminderGroups` 中指定的群组。

## 下一步

- [查看配置选项](/guide/config)
- [了解其他功能](/guide/features)
- [常见问题解答](/guide/faq)

