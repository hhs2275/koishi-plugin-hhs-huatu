# 队列系统

智能队列系统用于解决多用户并发时的 API 限流（429 错误）问题。

## 工作原理

### 队列机制

1. **任务接收**：用户发送绘图指令
2. **加入队列**：任务进入等待队列
3. **并发控制**：根据配置控制同时处理的任务数
4. **依次处理**：按顺序处理每个任务
5. **完成通知**：完成后发送结果给用户

### 限制策略

```
总队列限制
    └─ 单用户队列限制
          └─ 冷却时间
```

## 配置选项

### 基础配置

```yaml
maxQueueSize: 50              # 最大队列数量（包括正在处理）
maxUserQueueSize: 3           # 单用户最大队列数量
maxConcurrentRequests: 1      # 最大并发请求数
```

### 惩罚机制

```yaml
penaltyCooldown: 300000       # 超出限制的惩罚CD（毫秒）
                              # 5分钟 = 5 * 60 * 1000 = 300000
```

### 其他选项

```yaml
showQueueInfo: true           # 是否显示队列提示
maxRedrawCount: 2             # 单次最大重画数量
resetQueueAuth: 3             # 重置队列所需权限等级
```

## 使用场景

### 场景 1：用户正常使用

```
用户A发送指令 → 加入队列 → 处理 → 返回结果
```

队列状态：`1/50`，用户A队列：`1/3`

### 场景 2：多用户并发

```
用户A发送指令 → 队列位置 1
用户B发送指令 → 队列位置 2
用户C发送指令 → 队列位置 3
```

队列状态：`3/50`

根据 `maxConcurrentRequests` 设置，同时处理对应数量的任务。

### 场景 3：单用户超限

```
用户A连续发送4个指令：
- 指令1 → 加入队列（用户队列：1/3）
- 指令2 → 加入队列（用户队列：2/3）
- 指令3 → 加入队列（用户队列：3/3）
- 指令4 → 被拒绝，进入惩罚CD
```

用户A将在 `penaltyCooldown` 时间内无法使用绘图功能。

### 场景 4：队列已满

```
队列状态：50/50

新用户发送指令 → 提示"队列已满，请稍后再试"
```

## 队列状态查询

### 查看队列状态

```bash
novelai.queue
```

返回示例：
```
【队列状态】
当前队列：12/50
正在处理：3
等待中：9

【用户队列统计】
用户 123456789：2/3
用户 987654321：1/3
用户 456789123：1/3
...
```

## 管理指令

### 重置用户队列

::: warning 需要管理员权限
默认需要权限等级 3 或以上（可在配置中调整）。
:::

```bash
# 重置指定用户的队列状态
novelai.reset-queue 123456789

# 返回示例
# 已重置用户 123456789 的队列状态
```

**作用：**
- 清除用户的队列计数
- 清除用户的惩罚CD
- 允许用户重新使用

**使用场景：**
- 用户误触发超限
- 队列系统异常
- 特殊情况需要重置

## 配置建议

### 小型Bot（1-10人）

```yaml
maxQueueSize: 20
maxUserQueueSize: 5
maxConcurrentRequests: 1
penaltyCooldown: 60000      # 1分钟
```

### 中型Bot（10-50人）

```yaml
maxQueueSize: 50
maxUserQueueSize: 3
maxConcurrentRequests: 2
penaltyCooldown: 300000     # 5分钟
```

### 大型Bot（50+人）

```yaml
maxQueueSize: 100
maxUserQueueSize: 2
maxConcurrentRequests: 4
penaltyCooldown: 600000     # 10分钟
```

::: tip 提示
`maxConcurrentRequests` 应该根据你的 Token 数量来设置。建议不超过 Token 数量。
:::

## 工作流程图

```
用户发送指令
    ↓
检查队列是否已满？
    ├─ 是 → 返回"队列已满"
    └─ 否 → 继续
         ↓
检查用户队列是否超限？
    ├─ 是 → 进入惩罚CD
    └─ 否 → 继续
         ↓
加入队列
    ↓
等待轮到该任务
    ↓
检查并发数是否达到上限？
    ├─ 是 → 继续等待
    └─ 否 → 开始处理
         ↓
调用 API 生成图片
    ↓
返回结果
    ↓
从队列移除
```

## 监控和调试

### 查看队列信息

启用 `showQueueInfo` 后，用户提交任务时会看到队列提示：

```
您的任务已加入队列
当前队列：12/50
您的位置：第 12 位
预计等待时间：约 2 分钟
```

### 启用调试日志

在配置中启用 `debugLog`，可以看到：
- 队列状态变化
- 任务处理进度
- 并发控制信息

### 常见问题

**Q: 队列一直卡住不动？**

可能原因：
- API 请求超时
- Token 失效
- 网络问题

解决方法：
1. 检查日志错误
2. 重启插件
3. 使用 `reset-queue` 重置

**Q: 用户被误判超限？**

使用管理员指令重置：
```bash
novelai.reset-queue <用户ID>
```

**Q: 如何调整队列大小？**

根据你的 Bot 规模和 Token 数量调整：
- Token 越多 → `maxConcurrentRequests` 越大
- 用户越多 → `maxQueueSize` 越大
- 限制滥用 → `maxUserQueueSize` 越小

## 与会员系统配合

会员系统可以与队列系统配合使用：

```yaml
# 队列系统
maxUserQueueSize: 2           # 非会员限制2个

# 会员系统
membershipEnabled: true
# 可以在代码中扩展：给会员更高的队列限制
```

::: tip 扩展思路
未来版本可能添加会员专属队列、优先级队列等功能。
:::

## 性能优化

### 提高吞吐量

1. **增加并发数**：`maxConcurrentRequests: 3`
2. **配置多Token**：支持并行处理
3. **优化参数**：减少迭代步数

### 防止滥用

1. **限制用户队列**：`maxUserQueueSize: 2`
2. **增加惩罚CD**：`penaltyCooldown: 600000`（10分钟）
3. **启用会员系统**：限制非会员使用

## 下一步

- [配置会员系统](/guide/membership)
- [查看所有配置](/guide/config)
- [常见问题](/guide/faq)

