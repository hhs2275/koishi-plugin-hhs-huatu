# 图片审核系统

图片审核系统可以自动审核生成的图片，过滤不当内容，保障社区内容安全。

## 支持的审核引擎

### 腾讯云数据万象

- ✅ 高精度识别
- ✅ 低延时响应
- ✅ 标签丰富
- ✅ 实时更新识别标准

### API4AI

- ✅ 快速部署
- ✅ 易于配置
- ✅ NSFW 识别

## 基础配置

### 启用审核

在插件配置的「图片审核设置」中：

```yaml
imageReviewEnabled: true            # 启用图片审核
imageReviewFailAction: block        # 审核失败时阻止发送
muteOnReviewFailed: false          # 不自动禁言
muteTime: 60000                    # 禁言时长（毫秒）
enabledGroups: []                  # 所有群都启用（空数组）
```

### 失败处理方式

| 选项 | 说明 | 适用场景 |
|------|------|----------|
| `block` | 阻止发送 | 严格管理的社区 |
| `ignore` | 忽略错误 | 宽松的社区，仅记录日志 |

### 自动禁言

```yaml
muteOnReviewFailed: true           # 启用自动禁言
muteTime: 300000                   # 禁言5分钟
```

### 指定审核群组

```yaml
enabledGroups:
  - "123456789"    # 仅在这些群启用审核
  - "987654321"
```

留空则在所有群启用。

## 腾讯云配置

### 准备工作

1. 注册腾讯云账号
2. 开通数据万象服务
3. 创建存储桶
4. 获取密钥和策略

详细步骤请查看 [腾讯云审核配置](/guide/tencent-audit)。

### 配置参数

```yaml
imageAudit:
  engine: tencent
  secretId: "your_secret_id"
  secretKey: "your_secret_key"
  region: "ap-chengdu"
  bucket: "your-bucket-1234567890"
  bizType: "912f9a305ae1101b9f7430435ec51f66"
```

### 支持的地域

| 地域 | Region 代码 |
|------|------------|
| 北京 | ap-beijing |
| 上海 | ap-shanghai |
| 广州 | ap-guangzhou |
| 成都 | ap-chengdu |
| 重庆 | ap-chongqing |
| 南京 | ap-nanjing |
| 香港 | ap-hongkong |
| 新加坡 | ap-singapore |
| 孟买 | ap-mumbai |
| 法兰克福 | eu-frankfurt |

### 价格

- **免费额度**：10万次/2个月
- **超出后计费**：按次数收费
- **新用户优惠**：可低价购买额度

[腾讯云专场特惠](https://cloud.tencent.com/act/pro/ci)

## API4AI 配置

### 基础设置

```yaml
imageAudit:
  engine: api4ai
  api4ai:
    nsfwThreshold: 0.7      # NSFW阈值（0-1，越低越严格）
```

### 阈值说明

| 阈值 | 说明 | 适用场景 |
|------|------|----------|
| 0.5 | 严格 | 未成年用户群体 |
| 0.7 | 中等（推荐） | 一般社区 |
| 0.9 | 宽松 | 成人社区 |

## 审核流程

```
生成图片
    ↓
发送到审核API
    ↓
等待审核结果（1-3秒）
    ↓
审核通过？
    ├─ 是 → 发送图片给用户
    └─ 否 → 根据配置处理
         ├─ block：不发送，提示用户
         └─ ignore：发送图片，记录日志
              ↓
         是否启用自动禁言？
              ├─ 是 → 禁言用户
              └─ 否 → 仅提示
```

## 审核结果

### 通过

```
[图片审核] 审核通过: 正常内容, 分数: 0.15
```

用户会正常收到图片。

### 不通过

```
[图片审核] 审核未通过: 涉及敏感内容, 分数: 0.85
```

根据配置：
- `block`：提示"图片审核未通过，已阻止发送"
- `ignore`：仍然发送图片

如果启用自动禁言，还会禁言用户。

## 使用建议

### 1. 选择合适的引擎

**腾讯云数据万象：**
- ✅ 精度高
- ✅ 标签详细
- ❌ 需要配置存储桶
- 💰 有免费额度

**API4AI：**
- ✅ 配置简单
- ✅ 响应快速
- ❌ 功能相对简单
- 💰 按调用收费

### 2. 设置合理的处理方式

**严格管理：**
```yaml
imageReviewFailAction: block
muteOnReviewFailed: true
muteTime: 600000              # 10分钟
```

**宽松管理：**
```yaml
imageReviewFailAction: ignore
muteOnReviewFailed: false
```

### 3. 指定审核范围

仅在特定群组启用审核：

```yaml
enabledGroups:
  - "公共群组ID"
  # 私聊和其他群组不审核
```

### 4. 监控审核情况

启用调试日志查看详细的审核信息：

```yaml
debugLog: true
```

## 性能影响

### 延时

- 腾讯云：通常 1-2 秒
- API4AI：通常 1-3 秒

### 成本

**腾讯云：**
- 免费额度：10万次/2个月
- 超出后：约 0.0015 元/次
- 月使用10万次约需 150 元

**API4AI：**
- 按调用计费
- 具体价格见官方

### 优化建议

1. **仅在必要群组启用**
2. **使用 `ignore` 模式减少影响**
3. **监控使用量，避免超额**

## 调试和排查

### 启用调试日志

```yaml
debugLog: true
```

可以看到：
```
[图片审核] 开始图片审核...
[图片审核] 审核通过: 正常内容, 分数: 0.12
```

### 常见问题

**Q: 审核一直失败？**

检查：
1. 腾讯云密钥是否正确
2. 存储桶和地域是否匹配
3. BizType 是否正确
4. 是否有余额

**Q: 审核太慢？**

优化：
1. 选择就近的地域
2. 考虑切换到 API4AI
3. 关闭不必要的审核

**Q: 误判率高？**

调整：
1. API4AI：调整阈值
2. 腾讯云：调整策略设置
3. 使用 `ignore` 模式，手动检查

## 最佳实践

### 1. 分级管理

```yaml
# 公共群组 - 严格审核
enabledGroups: ["公共群1", "公共群2"]
imageReviewFailAction: block
muteOnReviewFailed: true

# 私密群组 - 不审核或宽松审核
```

### 2. 审核策略

- **新群组**：先启用审核，观察一段时间
- **信任群组**：可以关闭审核
- **问题群组**：启用严格审核+自动禁言

### 3. 成本控制

- 监控每月使用量
- 在免费额度内合理分配
- 只在必要群组启用

### 4. 用户体验

- 使用 `ignore` 模式减少干扰
- 提供清晰的审核失败提示
- 允许用户申诉（人工审核）

## 下一步

- [腾讯云详细配置](/guide/tencent-audit)
- [查看所有配置](/guide/config)
- [常见问题](/guide/faq)

